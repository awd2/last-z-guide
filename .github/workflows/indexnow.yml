name: IndexNow Ping

on:
  page_build:
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Download sitemap
        run: curl -sS https://lastzguides.com/sitemap.xml -o sitemap.xml

      - name: Build URL list and send to IndexNow
        env:
          KEY: dd8b3d12471744c4ad67e9dc368f04cd
          KEY_LOC: https://lastzguides.com/dd8b3d12471744c4ad67e9dc368f04cd.txt
        run: |
          URLS=$(python -c 'import xml.etree.ElementTree as ET, json; ns={"sm":"http://www.sitemaps.org/schemas/sitemap/0.9"}; tree=ET.parse("sitemap.xml"); urls=[loc.text for loc in tree.findall(".//sm:loc", ns)]; print(json.dumps(urls))')
          payload=$(jq -n \
            --arg host "lastzguides.com" \
            --arg key "$KEY" \
            --arg keyLocation "$KEY_LOC" \
            --argjson urlList "$URLS" \
            '{host:$host,key:$key,keyLocation:$keyLocation,urlList:$urlList}')
          http_code=$(curl -sS -o indexnow-response.json -w "%{http_code}" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "$payload" https://api.indexnow.org/IndexNow)
          echo "IndexNow HTTP $http_code"
          cat indexnow-response.json || true

      - name: Authenticate to Google (Search Console)
        id: gsc_auth
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GSC_SA_KEY }}
          token_format: "access_token"
          access_token_scopes: "https://www.googleapis.com/auth/webmasters"

      - name: Submit sitemap to GSC (domain property)
        env:
          ACCESS_TOKEN: ${{ steps.gsc_auth.outputs.access_token }}
        run: |
          SITE_URL="sc-domain:lastzguides.com"
          SITEMAP_URL="https://lastzguides.com/sitemap.xml"
          enc_site=$(python -c 'import urllib.parse; print(urllib.parse.quote("sc-domain:lastzguides.com", safe=""))')
          enc_sitemap=$(python -c 'import urllib.parse; print(urllib.parse.quote("https://lastzguides.com/sitemap.xml", safe=""))')
          http_code=$(curl -sS -o gsc-response.json -w "%{http_code}" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -X PUT \
            "https://www.googleapis.com/webmasters/v3/sites/${enc_site}/sitemaps/${enc_sitemap}")
          echo "GSC sitemap submit HTTP $http_code"
          cat gsc-response.json || true
